<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Imagen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            background: #000000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #imageContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000000;
        }

        #protectedImage {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Capa de protección invisible que se activa durante capturas */
        #protectionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease;
        }

        /* Capa adicional para bloquear capturas */
        #captureBlocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
        }

        /* Ocultar imagen durante impresión */
        @media print {
            #protectedImage {
                display: none !important;
            }
            body {
                background: #000000 !important;
            }
        }

        /* Protección contra herramientas de desarrollador - solo marcador, sin ocultar contenido */
        .dev-tools-detected {
            /* Removido el estilo que ocultaba todo el contenido */
            /* Solo mantener como marcador de estado */
        }

        /* Capa anti-captura móvil avanzada */
        #mobileCaptureShield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            z-index: 15000;
            pointer-events: none;
            opacity: 0;
            transition: none;
            mix-blend-mode: normal;
        }

        /* Activación durante captura móvil */
        .mobile-capture-active #mobileCaptureShield {
            background: #000000 !important;
            opacity: 1 !important;
            mix-blend-mode: multiply !important;
        }

        /* Protección específica para dispositivos móviles */
        @media (max-width: 768px), (pointer: coarse) {
            #mobileCaptureShield {
                background: rgba(0, 0, 0, 0.01);
            }
            
            /* Ocultar imagen durante eventos de captura móvil */
            .mobile-screenshot-detected #protectedImage {
                opacity: 0 !important;
                visibility: hidden !important;
            }
            
            .mobile-screenshot-detected #mobileCaptureShield {
                background: #000000 !important;
                opacity: 1 !important;
            }
        }

        /* Protección contra herramientas de accesibilidad usadas para capturas */
        @media (prefers-reduced-motion: reduce) {
            #mobileCaptureShield {
                background: rgba(0, 0, 0, 0.02);
            }
        }

        /* Protección durante cambios de orientación (común en capturas) */
        @media (orientation: portrait) {
            .orientation-change-detected #mobileCaptureShield {
                background: #000000 !important;
                opacity: 1 !important;
            }
        }

        @media (orientation: landscape) {
            .orientation-change-detected #mobileCaptureShield {
                background: #000000 !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body>
    <div id="imageContainer">
        <img id="protectedImage" alt="Imagen protegida" style="display: none;">
    </div>
    
    <!-- Capas de protección -->
    <div id="protectionOverlay"></div>
    <div id="captureBlocker"></div>
    <div id="mobileCaptureShield"></div>

    <script>
        // Variables globales
        let isProtectionActive = false;
        let captureDetectionActive = false;
        let protectionOverlay = document.getElementById('protectionOverlay');
        let captureBlocker = document.getElementById('captureBlocker');
        let protectedImage = document.getElementById('protectedImage');

        // Función para cargar imagen desde código
        function loadImage(imageSrc) {
            protectedImage.src = imageSrc;
            protectedImage.style.display = 'block';
            isProtectionActive = true;
            initAllProtections();
        }

        // Variables para detección avanzada
        let isBlackLayerActive = false;
        let lastActivityTime = Date.now();
        
        // Variables para control de focus/touch
        let isImageHiddenByFocus = false;
        let isImageHiddenByTouch = false;
        let suspiciousActivityCount = 0;
        
        // Variables para dispositivos móviles
        let isMobileDevice = false;
        let mobileScreenshotAttempts = 0;
        let lastTouchTime = 0;
        let touchSequenceCount = 0;
        
        // Función para activar capa negra (simula captura negra)
        function activateBlackLayer(duration = 500) {
            if (isBlackLayerActive) return;
            
            isBlackLayerActive = true;
            protectionOverlay.style.opacity = '1';
            captureBlocker.style.opacity = '1';
            protectedImage.style.opacity = '0';
            
            // Mantener la capa negra por más tiempo
            setTimeout(() => {
                if (isBlackLayerActive) {
                    protectionOverlay.style.opacity = '0';
                    captureBlocker.style.opacity = '0';
                    protectedImage.style.opacity = '1';
                    isBlackLayerActive = false;
                }
            }, duration);
        }

        // Función para activar protección permanente
        function activatePermanentProtection() {
            protectionOverlay.style.opacity = '1';
            captureBlocker.style.opacity = '1';
            protectedImage.style.display = 'none';
            document.body.style.background = '#000000';
        }

        // Función para controlar visibilidad de imagen por focus/touch
        function updateImageVisibility() {
            // Solo aplicar si no hay capa negra activa
            if (!isBlackLayerActive) {
                if (isImageHiddenByFocus || isImageHiddenByTouch) {
                    protectedImage.style.opacity = '0';
                    protectionOverlay.style.opacity = '1';
                } else {
                    protectedImage.style.opacity = '1';
                    protectionOverlay.style.opacity = '0';
                }
            }
        }

        // Función para detectar dispositivos móviles
        function detectMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const mobileKeywords = ['android', 'iphone', 'ipad', 'ipod', 'blackberry', 'windows phone', 'mobile', 'tablet'];
            
            isMobileDevice = mobileKeywords.some(keyword => userAgent.includes(keyword)) ||
                           /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                           ('ontouchstart' in window) ||
                           (navigator.maxTouchPoints > 0);
            
            return isMobileDevice;
        }

        // Detección avanzada de capturas de pantalla
        function initScreenshotProtection() {
            // Detección de teclas más agresiva
            document.addEventListener('keydown', function(e) {
                lastActivityTime = Date.now();
                
                // Print Screen y variantes
                if (e.key === 'PrintScreen' || e.code === 'PrintScreen' ||
                    (e.altKey && e.key === 'PrintScreen') ||
                    (e.metaKey && e.shiftKey && (e.key === 'S' || e.key === 's')) ||
                    (e.ctrlKey && e.shiftKey && (e.key === 'S' || e.key === 's'))) {
                    
                    e.preventDefault();
                    e.stopPropagation();
                    suspiciousActivityCount++;
                    activateBlackLayer(2000); // 2 segundos de protección
                    
                    if (suspiciousActivityCount > 3) {
                        activatePermanentProtection();
                    }
                    return false;
                }

                // Herramientas de desarrollador
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
                    (e.ctrlKey && (e.key === 'U' || e.key === 'u'))) {
                    e.preventDefault();
                    activateBlackLayer(1500);
                    return false;
                }

                // Operaciones de copia/guardado
                if (e.ctrlKey || e.metaKey) {
                    if (['c', 'C', 'a', 'A', 's', 'S', 'p', 'P', 'x', 'X', 'v', 'V'].includes(e.key)) {
                        e.preventDefault();
                        activateBlackLayer(1000);
                        return false;
                    }
                }
            });

            // Detección por keyup también (para capturas que no disparan keydown)
            document.addEventListener('keyup', function(e) {
                if (e.key === 'PrintScreen' || e.code === 'PrintScreen') {
                    activateBlackLayer(2000);
                }
            });

            // Detección por pérdida de foco inmediata
            let focusLossCount = 0;
            window.addEventListener('blur', function() {
                focusLossCount++;
                activateBlackLayer(1500);
                
                if (focusLossCount > 5) {
                    activatePermanentProtection();
                }
            });
        }

        // Detección de herramientas de captura adicionales
        function initAdvancedCaptureDetection() {
            // Detección de herramientas de captura por nombre de proceso (limitado en navegador)
            // Pero podemos detectar comportamientos sospechosos
            
            // Detección de movimiento del mouse sospechoso
            let mouseMovements = 0;
            let lastMouseTime = Date.now();
            
            document.addEventListener('mousemove', function(e) {
                mouseMovements++;
                const currentTime = Date.now();
                
                // Si hay muchos movimientos muy rápidos, puede ser automatización
                if (currentTime - lastMouseTime < 10 && mouseMovements > 50) {
                    activateBlackLayer(2000);
                }
                
                lastMouseTime = currentTime;
                lastActivityTime = currentTime;
            });

            // Detección de clics sospechosos
            document.addEventListener('click', function(e) {
                // Prevenir clics en la imagen
                if (e.target === protectedImage) {
                    e.preventDefault();
                    activateBlackLayer(1000);
                }
            });

            // Detección de intentos de arrastrar la imagen
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                activateBlackLayer(1500);
                return false;
            });

            // Protección contra selección de texto/imagen
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                activateBlackLayer(500);
                return false;
            });
        }

        // Protección contra pérdida de foco y cambios de visibilidad
        function initVisibilityProtection() {
            // Monitoreo de visibilidad más agresivo
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    suspiciousActivityCount++;
                    activateBlackLayer(3000); // 3 segundos de protección
                    
                    if (suspiciousActivityCount > 2) {
                        activatePermanentProtection();
                    }
                }
            });

            // Detección de pérdida de foco con contador
            let blurCount = 0;
            window.addEventListener('blur', function() {
                blurCount++;
                activateBlackLayer(2000);
                
                if (blurCount > 3) {
                    activatePermanentProtection();
                }
            });

            // Monitoreo continuo de actividad sospechosa
            setInterval(function() {
                const currentTime = Date.now();
                const timeSinceLastActivity = currentTime - lastActivityTime;
                
                // Si no hay actividad por mucho tiempo, puede ser sospechoso
                if (timeSinceLastActivity > 30000) { // 30 segundos
                    lastActivityTime = currentTime;
                }
            }, 5000);

            // Detección de cambio de tamaño de ventana (posible captura)
            window.addEventListener('resize', function() {
                activateBlackLayer(1000);
            });

            // Reactivar protecciones al volver
            window.addEventListener('focus', function() {
                setTimeout(initAllProtections, 100);
            });
        }

        // Protección contra herramientas de desarrollador
        function initDevToolsProtection() {
            let devToolsOpen = false;
            
            function detectDevTools() {
                const threshold = 160;
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;
                
                if (widthThreshold || heightThreshold) {
                    if (!devToolsOpen) {
                        devToolsOpen = true;
                        document.body.classList.add('dev-tools-detected');
                        
                        // Solo mostrar advertencia, no ocultar la imagen automáticamente
                        console.warn('Herramientas de desarrollo detectadas. La protección está activa.');
                        
                        // Preparar protecciones pero no activarlas hasta que sea necesario
                        const protectionOverlay = document.getElementById('protectionOverlay');
                        if (protectionOverlay) {
                            protectionOverlay.style.display = 'none'; // Mantener oculto hasta activación manual
                        }
                    }
                }
            }

            setInterval(detectDevTools, 100);

            // Protección adicional contra debugger
            setInterval(() => {
                if (isProtectionActive) {
                    try {
                        debugger;
                    } catch (e) {
                        activateBlackLayer();
                    }
                }
            }, 1000);
        }

        // Protección contra clic derecho y menú contextual
        function initRightClickProtection() {
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                activateBlackLayer();
                return false;
            });

            // Protección táctil
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                    activateBlackLayer();
                }
            });
        }

        // Función para manejar focus/touch que oculta imagen hasta perder foco
        function initFocusTouchControl() {
            // Solo activar si hay intentos de captura detectados
            // Eventos de focus - ocultar imagen al obtener foco (solo si hay actividad sospechosa)
            window.addEventListener('focus', function() {
                if (!isBlackLayerActive && mobileScreenshotAttempts > 0) {
                    isImageHiddenByFocus = true;
                    updateImageVisibility();
                }
            });

            // Eventos de blur - mostrar imagen al perder foco
            window.addEventListener('blur', function() {
                if (!isBlackLayerActive) {
                    isImageHiddenByFocus = false;
                    updateImageVisibility();
                }
            });

            // Eventos de touch - ocultar imagen al tocar (solo si hay actividad sospechosa)
            document.addEventListener('touchstart', function(e) {
                if (!isBlackLayerActive && mobileScreenshotAttempts > 0) {
                    isImageHiddenByTouch = true;
                    updateImageVisibility();
                }
            });

            // Eventos de touch end - mostrar imagen al dejar de tocar
            document.addEventListener('touchend', function(e) {
                if (!isBlackLayerActive) {
                    isImageHiddenByTouch = false;
                    updateImageVisibility();
                }
            });

            // Eventos de mouse - ocultar imagen al hacer clic (solo si hay actividad sospechosa)
            document.addEventListener('mousedown', function(e) {
                if (!isBlackLayerActive && mobileScreenshotAttempts > 0) {
                    isImageHiddenByTouch = true;
                    updateImageVisibility();
                }
            });

            // Eventos de mouse up - mostrar imagen al soltar clic
            document.addEventListener('mouseup', function(e) {
                if (!isBlackLayerActive) {
                    isImageHiddenByTouch = false;
                    updateImageVisibility();
                }
            });
        }

        // Protección contra arrastrar y seleccionar
        function initDragProtection() {
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                activateBlackLayer();
                return false;
            });

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });
        }

        // Detección de cambios en el DOM (posibles inyecciones)
        function initDOMProtection() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && 
                                (node.tagName === 'SCRIPT' || node.tagName === 'IFRAME')) {
                                node.remove();
                                activateBlackLayer();
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Protección contra capturas por cambio de tamaño de ventana
        function initWindowProtection() {
            let lastWidth = window.innerWidth;
            let lastHeight = window.innerHeight;

            window.addEventListener('resize', function() {
                if (isProtectionActive) {
                    const widthChange = Math.abs(window.innerWidth - lastWidth);
                    const heightChange = Math.abs(window.innerHeight - lastHeight);
                    
                    // Si hay un cambio significativo, podría ser una captura
                    if (widthChange > 50 || heightChange > 50) {
                        activateBlackLayer();
                    }
                    
                    lastWidth = window.innerWidth;
                    lastHeight = window.innerHeight;
                }
            });
        }

        // Protección contra inspección de red
        function initNetworkProtection() {
            // Bloquear acceso a recursos de imagen
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                activateBlackLayer();
                return originalFetch.apply(this, args);
            };

            // Bloquear XMLHttpRequest
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                xhr.open = function() {
                    activateBlackLayer();
                    return originalOpen.apply(this, arguments);
                };
                return xhr;
            };
        }

        // Detección de extensiones de captura de pantalla
        function initExtensionDetection() {
            // Lista de extensiones conocidas de captura
            const suspiciousExtensions = [
                'lightshot', 'awesome-screenshot', 'fireshot', 'nimbus-screenshot',
                'full-page-screen-capture', 'screenshot-capture', 'gyazo',
                'snagit', 'greenshot', 'sharex', 'puush', 'cloudapp'
            ];

            // Detectar extensiones por inyección de scripts
            const scripts = document.querySelectorAll('script');
            scripts.forEach(script => {
                if (script.src) {
                    suspiciousExtensions.forEach(ext => {
                        if (script.src.toLowerCase().includes(ext)) {
                            activateBlackLayer();
                        }
                    });
                }
            });

            // Detectar modificaciones del DOM por extensiones
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                const className = node.className || '';
                                const id = node.id || '';
                                
                                // Detectar elementos típicos de extensiones de captura
                                if (className.includes('screenshot') || 
                                    className.includes('capture') ||
                                    className.includes('lightshot') ||
                                    id.includes('screenshot') ||
                                    id.includes('capture')) {
                                    activateBlackLayer();
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class', 'id']
            });
        }

        // Protección contra API de captura de pantalla
        function initScreenCaptureAPIProtection() {
            // Bloquear getDisplayMedia (Screen Capture API)
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
                navigator.mediaDevices.getDisplayMedia = function() {
                    activateBlackLayer();
                    return Promise.reject(new Error('Screen capture blocked'));
                };
            }

            // Bloquear getUserMedia con screen capture
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const originalGetUserMedia = navigator.mediaDevices.getUserMedia;
                navigator.mediaDevices.getUserMedia = function(constraints) {
                    if (constraints && constraints.video && 
                        (constraints.video.mediaSource === 'screen' || 
                         constraints.video.chromeMediaSource === 'screen')) {
                        activateBlackLayer();
                        return Promise.reject(new Error('Screen capture blocked'));
                    }
                    return originalGetUserMedia.apply(this, arguments);
                };
            }

            // Detectar WebRTC screen sharing
            const originalCreateOffer = RTCPeerConnection.prototype.createOffer;
            RTCPeerConnection.prototype.createOffer = function() {
                activateBlackLayer();
                return originalCreateOffer.apply(this, arguments);
            };
        }

        // Protecciones específicas para dispositivos móviles
        function initMobileScreenshotProtection() {
            if (!isMobileDevice) return;

            const mobileCaptureShield = document.getElementById('mobileCaptureShield');
            let captureDetectionTimer = null;
            let orientationChangeTimer = null;
            let visibilityChangeTimer = null;

            // Función para activar la capa anti-captura móvil
            function activateMobileCaptureShield(duration = 3000) {
                document.body.classList.add('mobile-capture-active');
                document.body.classList.add('mobile-screenshot-detected');
                
                mobileScreenshotAttempts++;
                console.clear();
                
                if (captureDetectionTimer) {
                    clearTimeout(captureDetectionTimer);
                }
                
                captureDetectionTimer = setTimeout(() => {
                    document.body.classList.remove('mobile-capture-active');
                    document.body.classList.remove('mobile-screenshot-detected');
                }, duration);
                
                if (mobileScreenshotAttempts > 3) {
                    activatePermanentProtection();
                }
            }

            // Detectar cambios de orientación (muy común durante capturas móviles)
            window.addEventListener('orientationchange', function() {
                document.body.classList.add('orientation-change-detected');
                activateMobileCaptureShield(2000);
                
                if (orientationChangeTimer) {
                    clearTimeout(orientationChangeTimer);
                }
                
                orientationChangeTimer = setTimeout(() => {
                    document.body.classList.remove('orientation-change-detected');
                }, 2000);
            });

            // Detectar eventos de visibilidad (capturas en segundo plano)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    activateMobileCaptureShield(4000);
                    
                    if (visibilityChangeTimer) {
                        clearTimeout(visibilityChangeTimer);
                    }
                    
                    visibilityChangeTimer = setTimeout(() => {
                        if (!document.hidden) {
                            initAllProtections();
                        }
                    }, 1000);
                }
            });

            // Detectar cambios en el estado de la aplicación
            window.addEventListener('pagehide', function() {
                activateMobileCaptureShield(3000);
            });

            window.addEventListener('pageshow', function(e) {
                if (e.persisted) {
                    activateMobileCaptureShield(2000);
                }
                setTimeout(initAllProtections, 200);
            });

            // Detectar patrones de touch sospechosos
            let touchStartTime = 0;
            let touchCount = 0;
            let rapidTouchCount = 0;
            let lastTouchTime = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchCount = e.touches.length;
                
                // Detectar múltiples toques simultáneos
                if (touchCount >= 3) {
                    activateMobileCaptureShield(2500);
                    e.preventDefault();
                }
                
                // Detectar secuencias rápidas de toques
                if (touchStartTime - lastTouchTime < 150) {
                    rapidTouchCount++;
                    if (rapidTouchCount > 4) {
                        activateMobileCaptureShield(2000);
                        rapidTouchCount = 0;
                    }
                } else {
                    rapidTouchCount = 0;
                }
                
                lastTouchTime = touchStartTime;
            });

            // Detectar toques largos (posibles gestos de captura)
            document.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                
                if (touchDuration > 1500) {
                    activateMobileCaptureShield(2000);
                }
            });

            // Detectar cambios en el zoom/escala
            let lastZoom = window.devicePixelRatio;
            let lastInnerWidth = window.innerWidth;
            let lastInnerHeight = window.innerHeight;
            
            setInterval(function() {
                const currentZoom = window.devicePixelRatio;
                const currentWidth = window.innerWidth;
                const currentHeight = window.innerHeight;
                
                if (currentZoom !== lastZoom || 
                    Math.abs(currentWidth - lastInnerWidth) > 50 ||
                    Math.abs(currentHeight - lastInnerHeight) > 50) {
                    
                    activateMobileCaptureShield(1500);
                    
                    lastZoom = currentZoom;
                    lastInnerWidth = currentWidth;
                    lastInnerHeight = currentHeight;
                }
            }, 300);

            // Detectar uso de herramientas de accesibilidad
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                // Monitorear intentos de usar síntesis de voz
                const originalSpeak = window.speechSynthesis.speak;
                window.speechSynthesis.speak = function() {
                    activateMobileCaptureShield(2000);
                    return originalSpeak.apply(this, arguments);
                };
            }

            // Detectar cambios en el estado de la red (común durante capturas)
            if ('connection' in navigator) {
                let lastConnectionType = navigator.connection.effectiveType;
                
                setInterval(() => {
                    if (navigator.connection.effectiveType !== lastConnectionType) {
                        activateMobileCaptureShield(1000);
                        lastConnectionType = navigator.connection.effectiveType;
                    }
                }, 1000);
            }

            // Protección continua en segundo plano
            setInterval(() => {
                if (mobileScreenshotAttempts > 0) {
                    console.clear();
                }
            }, 100);
        }

        // Detección avanzada de capturas móviles en tiempo real
        function initAdvancedMobileCaptureDetection() {
            if (!isMobileDevice) return;

            const mobileCaptureShield = document.getElementById('mobileCaptureShield');
            let suspiciousActivityCount = 0;
            let lastSuspiciousActivity = 0;

            // Función para activar protección inmediata (solo cuando hay actividad realmente sospechosa)
            function triggerImmediateProtection(reason, duration = 3000) {
                const now = Date.now();
                
                // Evitar activaciones demasiado frecuentes
                if (now - lastSuspiciousActivity < 2000) return;
                
                console.clear();
                document.body.classList.add('mobile-capture-active');
                document.body.classList.add('mobile-screenshot-detected');
                
                // Ocultar imagen temporalmente
                if (protectedImage) {
                    protectedImage.style.opacity = '0';
                    protectedImage.style.visibility = 'hidden';
                }
                
                mobileScreenshotAttempts++;
                lastSuspiciousActivity = now;
                
                setTimeout(() => {
                    document.body.classList.remove('mobile-capture-active');
                    document.body.classList.remove('mobile-screenshot-detected');
                    
                    // Restaurar imagen después del período de protección
                    if (protectedImage && mobileScreenshotAttempts < 5) {
                        protectedImage.style.opacity = '1';
                        protectedImage.style.visibility = 'visible';
                    }
                }, duration);
                
                if (mobileScreenshotAttempts > 4) {
                    activatePermanentProtection();
                }
            }

            // Monitoreo de rendimiento solo cuando hay actividad sospechosa confirmada
            function monitorPerformance() {
                // Solo monitorear si ya hay intentos de captura detectados
                if (mobileScreenshotAttempts === 0) return;
                
                if ('performance' in window && 'memory' in performance) {
                    const currentMemory = performance.memory.usedJSHeapSize;
                    
                    // Solo activar con uso de memoria extremadamente alto (50MB+)
                    if (currentMemory > 50000000) {
                        triggerImmediateProtection('extreme_memory_usage', 2000);
                    }
                }
            }

            // Monitoreo de contexto de renderizado solo para casos específicos
            function monitorRenderingContext() {
                // Desactivado para evitar falsos positivos durante uso normal
                // Solo se activará si se detectan múltiples intentos de captura
                return;
            }

            // Detectar cambios en APIs de captura
            function monitorCaptureAPIs() {
                // Interceptar getImageData
                if (CanvasRenderingContext2D.prototype.getImageData) {
                    const originalGetImageData = CanvasRenderingContext2D.prototype.getImageData;
                    CanvasRenderingContext2D.prototype.getImageData = function() {
                        triggerImmediateProtection('canvas_data_access', 5000);
                        return originalGetImageData.apply(this, arguments);
                    };
                }

                // Interceptar toDataURL
                if (HTMLCanvasElement.prototype.toDataURL) {
                    const originalToDataURL = HTMLCanvasElement.prototype.toDataURL;
                    HTMLCanvasElement.prototype.toDataURL = function() {
                        triggerImmediateProtection('canvas_export', 5000);
                        return originalToDataURL.apply(this, arguments);
                    };
                }

                // Interceptar html2canvas si está presente
                if (window.html2canvas) {
                    const originalHtml2canvas = window.html2canvas;
                    window.html2canvas = function() {
                        triggerImmediateProtection('html2canvas_detected', 10000);
                        return Promise.reject(new Error('Captura bloqueada'));
                    };
                }
            }

            // Detectar cambios en el DOM que indiquen herramientas de captura específicas
            function monitorDOMChanges() {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mobileScreenshotAttempts > 0) {
                            mutation.addedNodes.forEach(function(node) {
                                if (node.nodeType === 1) { // Element node
                                    const tagName = node.tagName ? node.tagName.toLowerCase() : '';
                                    
                                    // Detectar elementos sospechosos
                                    if (tagName === 'canvas' || 
                                        tagName === 'svg' ||
                                        (node.className && node.className.includes('screenshot')) ||
                                        (node.id && node.id.includes('capture'))) {
                                        
                                        triggerImmediateProtection('suspicious_element', 3000);
                                    }
                                }
                            });
                        }
                    });
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['class', 'id', 'style']
                });
            }

            // Detectar cambios en el estado del dispositivo
            function monitorDeviceState() {
                // Detectar cambios en la batería (común durante capturas intensivas)
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(function(battery) {
                        let lastLevel = battery.level;
                        
                        battery.addEventListener('levelchange', function() {
                            const levelDrop = lastLevel - battery.level;
                            if (levelDrop > 0.02) { // Caída significativa de batería
                                triggerImmediateProtection('battery_drain', 2000);
                            }
                            lastLevel = battery.level;
                        });
                    });
                }

                // Detectar cambios en la conectividad (desactivado para evitar falsos positivos)
                // window.addEventListener('online', function() {
                //     triggerImmediateProtection('connectivity_change', 1000);
                // });

                // window.addEventListener('offline', function() {
                //     triggerImmediateProtection('connectivity_change', 1000);
                // });
            }

            // Inicializar solo las detecciones esenciales
            monitorCaptureAPIs(); // Mantener APIs de captura
            monitorDOMChanges(); // Mantener pero con condiciones más estrictas

            // Ejecutar monitoreo de rendimiento cada 500ms (menos frecuente)
            setInterval(monitorPerformance, 500);

            // Protección adicional: limpiar console constantemente
            setInterval(() => {
                if (mobileScreenshotAttempts > 0) {
                    console.clear();
                    
                    // Interferir con herramientas de debugging
                    if (window.console && window.console.log) {
                        window.console.log = function() {};
                        window.console.warn = function() {};
                        window.console.error = function() {};
                    }
                }
            }, 50);
        }

        // Detección mejorada de herramientas de automatización
        function initAutomationDetection() {
            // Detectar Selenium WebDriver
            if (window.navigator.webdriver) {
                activateBlackLayer();
            }

            // Detectar Puppeteer/Playwright
            if (window.chrome && window.chrome.runtime && window.chrome.runtime.onConnect) {
                activateBlackLayer();
            }

            // Detectar PhantomJS
            if (window.callPhantom || window._phantom) {
                activateBlackLayer();
            }

            // Detectar automatización por timing de eventos
            let mouseEvents = 0;
            let keyEvents = 0;
            
            document.addEventListener('mousemove', function() {
                mouseEvents++;
            });
            
            document.addEventListener('keydown', function() {
                keyEvents++;
            });

            // Verificar patrones sospechosos cada 5 segundos
            setInterval(function() {
                // Si hay muchos eventos de teclado pero pocos de mouse, podría ser automatización
                if (keyEvents > 50 && mouseEvents < 10) {
                    activateBlackLayer();
                }
                
                // Reset counters
                mouseEvents = 0;
                keyEvents = 0;
            }, 5000);
        }

        // Protección contra canvas fingerprinting y extracción
        function initCanvasProtection() {
            const originalToDataURL = HTMLCanvasElement.prototype.toDataURL;
            const originalGetImageData = CanvasRenderingContext2D.prototype.getImageData;
            
            HTMLCanvasElement.prototype.toDataURL = function() {
                activateBlackLayer();
                return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            };
            
            CanvasRenderingContext2D.prototype.getImageData = function() {
                activateBlackLayer();
                return originalGetImageData.apply(this, arguments);
            };
        }

        // Protección contra análisis de píxeles y OCR
        function initAntiOCRProtection() {
            // Crear ruido visual que dificulte el OCR
            function addVisualNoise() {
                const noiseOverlay = document.createElement('div');
                noiseOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 10;
                    background-image: 
                        radial-gradient(circle at 20% 50%, transparent 20%, rgba(255,255,255,0.01) 21%, rgba(255,255,255,0.01) 34%, transparent 35%, transparent),
                        linear-gradient(0deg, rgba(255,255,255,0.01) 50%, transparent 50%);
                    background-size: 3px 3px, 1px 1px;
                    animation: noiseShift 0.1s infinite;
                `;
                
                // Agregar animación de ruido
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes noiseShift {
                        0% { transform: translate(0px, 0px); }
                        25% { transform: translate(1px, 0px); }
                        50% { transform: translate(0px, 1px); }
                        75% { transform: translate(1px, 1px); }
                        100% { transform: translate(0px, 0px); }
                    }
                `;
                document.head.appendChild(style);
                
                if (protectedImage && protectedImage.parentNode) {
                    protectedImage.parentNode.appendChild(noiseOverlay);
                }
            }

            // Aplicar ruido después de cargar la imagen
            setTimeout(addVisualNoise, 1000);
        }

        // Protección contra herramientas de análisis de red
        function initNetworkAnalysisProtection() {
            // Detectar herramientas de análisis de tráfico
            const suspiciousUserAgents = [
                'wireshark', 'fiddler', 'burpsuite', 'owasp', 'nmap', 'curl', 'wget'
            ];

            const userAgent = navigator.userAgent.toLowerCase();
            suspiciousUserAgents.forEach(tool => {
                if (userAgent.includes(tool)) {
                    activateBlackLayer();
                }
            });

            // Detectar requests sospechosos
            const originalSend = XMLHttpRequest.prototype.send;
            XMLHttpRequest.prototype.send = function() {
                // Cualquier request podría ser para análisis
                activateBlackLayer();
                return originalSend.apply(this, arguments);
            };
        }

        // Protección contra técnicas de ingeniería inversa
        function initReverseEngineeringProtection() {
            // Ofuscar código crítico
            const criticalFunctions = [
                'activateBlackLayer', 'initAllProtections', 'loadImage'
            ];

            // Detectar intentos de acceso a funciones críticas
            criticalFunctions.forEach(funcName => {
                if (window[funcName]) {
                    const originalFunc = window[funcName];
                    window[funcName] = function() {
                        // Verificar si la llamada es legítima
                        const stack = new Error().stack;
                        if (stack && stack.includes('eval')) {
                            activateBlackLayer();
                            return;
                        }
                        return originalFunc.apply(this, arguments);
                    };
                }
            });

            // Detectar uso de eval y Function constructor
            const originalEval = window.eval;
            window.eval = function() {
                activateBlackLayer();
                return originalEval.apply(this, arguments);
            };

            const originalFunction = window.Function;
            window.Function = function() {
                activateBlackLayer();
                return originalFunction.apply(this, arguments);
            };
        }

        // Protección contra técnicas de timing attack
        function initTimingAttackProtection() {
            // Randomizar tiempos de respuesta
            const originalSetTimeout = window.setTimeout;
            const originalSetInterval = window.setInterval;

            window.setTimeout = function(callback, delay) {
                const randomDelay = delay + Math.random() * 10;
                return originalSetTimeout.call(this, callback, randomDelay);
            };

            window.setInterval = function(callback, delay) {
                const randomDelay = delay + Math.random() * 10;
                return originalSetInterval.call(this, callback, randomDelay);
            };

            // Detectar medición de performance
            if (window.performance && window.performance.now) {
                const originalNow = window.performance.now;
                window.performance.now = function() {
                    activateBlackLayer();
                    return originalNow.apply(this, arguments) + Math.random() * 10;
                };
            }
        }

        // Protección contra ataques de memoria
        function initMemoryProtection() {
            // Limpiar variables sensibles periódicamente
            setInterval(function() {
                // Forzar garbage collection si está disponible
                if (window.gc) {
                    window.gc();
                }
                
                // Sobrescribir variables temporales
                for (let i = 0; i < 1000; i++) {
                    const dummy = new Array(1000).fill(Math.random());
                    dummy.length = 0;
                }
            }, 5000);

            // Detectar intentos de acceso a memoria
            if (window.MemoryInfo) {
                const originalMemoryInfo = window.MemoryInfo;
                window.MemoryInfo = function() {
                    activateBlackLayer();
                    return originalMemoryInfo.apply(this, arguments);
                };
            }
        }

        // Inicializar todas las protecciones
        function initAllProtections() {
            // Detectar dispositivo móvil primero
            detectMobileDevice();
            
            initScreenshotProtection();
            initAdvancedCaptureDetection();
            initVisibilityProtection();
            initDevToolsProtection();
            initRightClickProtection();
            initDragProtection();
            initFocusTouchControl();
            initDOMProtection();
            initWindowProtection();
            initNetworkProtection();
            initExtensionDetection();
            initScreenCaptureAPIProtection();
            initMobileScreenshotProtection();
            initAdvancedMobileCaptureDetection();
            initAutomationDetection();
            initCanvasProtection();
            initAntiOCRProtection();
            initNetworkAnalysisProtection();
            initReverseEngineeringProtection();
            initTimingAttackProtection();
            initMemoryProtection();

            // Limpiar consola periódicamente
            setInterval(() => {
                console.clear();
            }, 1000);

            // Protección final (con manejo de errores)
            try {
                Object.freeze(window);
                Object.freeze(document);
            } catch (e) {
                // Algunos navegadores no permiten congelar estos objetos
                console.log('Protección de congelado no disponible');
            }

            // Activar monitoreo continuo
            setInterval(function() {
                // Verificar si las protecciones siguen activas
                if (!isProtectionActive) {
                    initAllProtections();
                }
                
                // Verificar integridad de elementos críticos
                if (!protectionOverlay || !captureBlocker || !protectedImage) {
                    location.reload(); // Recargar si algo fue manipulado
                }
            }, 1000);
        }

        // Función pública para cargar imagen (usar desde código externo)
        window.loadProtectedImage = function(imageSrc) {
            loadImage(imageSrc);
        };

        // Auto-cargar imagen al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar imagen específica caso.jpeg
            loadImage('caso.jpeg');

            // También permitir parámetro URL como alternativa
            const urlParams = new URLSearchParams(window.location.search);
            const imageUrl = urlParams.get('img');
            
            if (imageUrl) {
                loadImage(decodeURIComponent(imageUrl));
            }

            // Activar protección básica
            initAllProtections();
        });

        // Protección contra modificación de variables
        Object.defineProperty(window, 'isProtectionActive', {
            writable: false,
            configurable: false
        });
    </script>
</body>
</html>